# AI-trans（上下文翻译浏览器扩展）

AI-trans 是一个基于可配置 LLM 翻译服务的浏览器扩展，支持对网页选中内容进行上下文感知的高质量翻译。它在同一卡片中呈现「完整句子翻译」「语境化翻译」「直译」与「语义说明」，并提供可拖拽的气泡、语言切换、点击外部关闭等交互。

## 主要功能
- 上下文感知翻译：同时返回完整句子翻译（避免遗漏）、语境化翻译、直译与语义说明
- 语言选择下拉：在结果卡片内快速切换目标语言
- 结果气泡可拖拽：通过标题栏拖动，避免遮挡页面内容
- 点击外部或 X 关闭：翻译完成后可快速隐藏结果气泡
- 本地 UI 预览页面：支持在开发环境中独立预览卡片样式

## 目录结构
```
├── README.md
├── README_EN.md
├── background.js         # Service Worker：统一请求 LLM 服务、错误与重试；从 storage.local 读取提供商配置
├── contentScript.js      # 内容脚本：选区监听、心形/柴犬图标、结果气泡渲染与交互
├── contentStyles.css     # UI 样式：结果气泡、标题栏、交互态（拖拽、关闭等）
├── icons/                # 扩展与浮层图标
├── manifest.json         # Manifest V3 配置（名称、权限、图标、options 入口）
├── options.html          # 选项页：配置 LLM 提供商（Base URL、Model、API Key）、目标语言、触发方式等
├── options.js            # 选项页逻辑：同步/本地存储、测试连接（/v1/models）
└── preview.html          # 开发预览页面：用于本地预览结果卡片样式
```

## 安装（开发模式）
1. 克隆或下载本仓库至本地
2. 打开 Chrome/Edge → 访问 `chrome://extensions` / `edge://extensions`
3. 开启「开发者模式」
4. 点击「加载已解压的扩展程序」，选择本项目根目录
5. 安装后在扩展管理页中确保 AI-trans 已启用

## 使用说明
- 在任意网页选中需要翻译的文本
- 选区附近会出现柴犬图标，点击后请求翻译并弹出结果气泡
- 结果卡片包含：
  - 完整句子翻译（确保句子/多分句不被截断）
  - 语境化翻译（结合上下文语义）
  - 直译（逐词/短语直译）
  - 语义说明（补充解释、用法）
- 交互：
  - 通过标题栏拖拽气泡，避免遮挡内容
  - 使用语言下拉切换目标语言
  - 点击外部区域或右上角 X 可关闭气泡

## LLM 提供商配置
- 选项页支持常见 OpenAI 兼容接口的提供商：DeepSeek、OpenAI、OpenRouter、Together AI、Groq，以及自定义
- 默认 Base URL 与示例 Model 会自动填充，可自行修改
- 保存后后台脚本从 `chrome.storage.local` 读取配置并使用统一的 `/v1/chat/completions`
- 可点击“测试连接”按钮调用 `/v1/models` 快速检测 Base URL 与 Key 配置是否正确

## 配置与安全
- 在扩展的「选项页」（options.html）中配置：
  - LLM 提供商的 Base URL、Model 与 API Key（仅本地保存，不同步）
  - 目标语言、触发方式（悬停/点击）、上下文窗口长度等
- 安全建议：
  - API Key 仅保存于浏览器本地（chrome.storage.local），不要提交到仓库
  - 不再依赖 `env.json` 存放密钥；如需本地示例，请勿写入真实密钥
  - Host 权限可收敛到实际使用的域名，遵循最小权限原则

## 权限与隐私
- Manifest V3 最小权限：`storage`、`activeTab`、`scripting`
- `host_permissions`：仅允许访问配置的翻译接口域名（默认支持通配以便测试）
- 隐私与安全：
  - 仅发送必要的选区与少量上下文
  - 不记录或上传页面的敏感信息
  - 不在日志或仓库中存储密钥

## 工作原理（简述）
- contentScript：
  - 监听选区与点击，插入触发图标（柴犬）
  - 收集选中内容与上下文，展示结果气泡并提供交互
- background：
  - 构造结构化提示（包含选区与上下文，使用安全包装）
  - 调用 LLM 翻译服务，返回结构化结果（完整句子/语境化/直译/语义说明等）
  - 统一错误处理与重试策略

## 本地预览（UI）
- 进入项目目录并启动本地服务器：
  - `python3 -m http.server 5500`
- 打开浏览器访问：`http://localhost:5500/preview.html`
- 用于查看与验证结果卡片的布局与交互（不触发真实接口）

## 打包与发布
- 将项目作为解压扩展直接使用，或打包为 ZIP 上传到扩展商店（根据商店要求）
- 发布前检查：
  - manifest 中名称与图标（本项目已使用「AI-trans」与 `icons/哈士奇.png`）
  - 权限最小化与隐私声明
  - 选项页引导用户配置 API Key（不内置密钥）

## 快速开始（Quick Start）
- 在任意网页选中文本，点击出现的柴犬图标触发翻译
- 在结果卡片中查看：完整句子翻译、语境化翻译、直译、语义说明
- 通过标题栏拖拽卡片，点击外部或 X 关闭，使用下拉切换语言

## 常见问题（FAQ）
- 语言下拉无法展开或无响应？
  - 我们已限制拖拽仅发生在标题栏，select/button 等交互元素不会被拖拽拦截。若仍异常，请尝试重新加载扩展。
- 柴犬图标不出现？
  - 请确认扩展已启用且你确实选中了文本；某些页面（如 PDF 或复杂 Shadow DOM）可能暂不支持。
- 点击外部未关闭？
  - 在翻译完成后会挂载一次性外部点击监听；如仍未关闭，可使用右上角 X。
- API Key 未配置或限流错误？
  - 在选项页配置你的翻译服务 API Key；遇限流请稍后重试。
- 拖拽后位置异常或不可见？
  - 我们使用 fixed 定位与视口坐标；刷新后位置重置，或拖回可见区域。

## 路线图（Roadmap）
- 支持 ESC 键关闭气泡
- 仅标题左侧区域可拖拽，进一步减少与交互控件冲突
- 翻译等级更清晰的可视化（标签/徽标）
- 可选的领域上下文（domain）以提升专业文本的准确率
- 结果卡片位置持久化与智能避让

## 参与贡献
- 欢迎提交 Issue/PR 改进功能与体验
- 建议在提交前先拉取最新 main 并 rebase

## 许可证
- 许可证：MIT（与仓库 LICENSE 一致）
- 版权：© 2026 snow-tao
